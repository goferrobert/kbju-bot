# üìã –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞

## üéØ **–û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–µ–¥–∏–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É aiogram 2.x** —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö SQLite.

## üìä **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**

### –¢–∞–±–ª–∏—Ü–∞ `users`:
- `telegram_id` (Primary Key) - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
- `username` - username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `first_name` - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `last_name` - —Ñ–∞–º–∏–ª–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `sex` - –ø–æ–ª ('male' / 'female')
- `date_of_birth` - –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
- `created_at` - –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏

### –¢–∞–±–ª–∏—Ü–∞ `user_records`:
- `id` (Primary Key) - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–ø–∏—Å–∏
- `telegram_id` (Foreign Key) - —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `date` - –¥–∞—Ç–∞ –∑–∞–ø–∏—Å–∏
- `weight` - –≤–µ—Å (–∫–≥)
- `waist` - –æ–±—Ö–≤–∞—Ç —Ç–∞–ª–∏–∏ (—Å–º)
- `neck` - –æ–±—Ö–≤–∞—Ç —à–µ–∏ (—Å–º)
- `hip` - –æ–±—Ö–≤–∞—Ç –±–µ–¥–µ—Ä (—Å–º, —Ç–æ–ª—å–∫–æ –¥–ª—è –∂–µ–Ω—â–∏–Ω)
- `height` - —Ä–æ—Å—Ç (—Å–º)
- `goal` - —Ü–µ–ª—å ('maintain', 'weight_loss', 'weight_gain')
- `steps` - —É—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—Å—Ç—Ä–æ–∫–∞)
- `sport_type` - —Ç–∏–ø —Å–ø–æ—Ä—Ç–∞
- `sport_freq` - —á–∞—Å—Ç–æ—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
- `step_multiplier` - –º–Ω–æ–∂–∏—Ç–µ–ª—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- `bodyfat` - –ø—Ä–æ—Ü–µ–Ω—Ç –∂–∏—Ä–∞

## üîÑ **–°—Ü–µ–Ω–∞—Ä–∏–π "–ü–µ—Ä–≤–æ–µ –∫–∞—Å–∞–Ω–∏–µ"**

**–§–∞–π–ª:** `handlers/start_handlers.py`

### –ü—Ä–æ—Ü–µ—Å—Å:
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç ‚Üí –Ω–∞—á–∏–Ω–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é

2. **–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   - –ò–º—è
   - –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
   - –ü–æ–ª
   - –†–æ—Å—Ç
   - –í–µ—Å
   - –û–±—Ö–≤–∞—Ç —Ç–∞–ª–∏–∏
   - –û–±—Ö–≤–∞—Ç —à–µ–∏
   - –û–±—Ö–≤–∞—Ç –±–µ–¥–µ—Ä (—Ç–æ–ª—å–∫–æ –¥–ª—è –∂–µ–Ω—â–∏–Ω)
   - –£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—à–∞–≥–∏)
   - –¢–∏–ø —Å–ø–æ—Ä—Ç–∞
   - –ß–∞—Å—Ç–æ—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
   - –¶–µ–ª—å

3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î:**
   ```python
   # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   user = User(
       telegram_id=message.from_user.id,
       username=message.from_user.username,
       first_name=name,
       sex=sex,
       date_of_birth=birth_date,
       height=height
   )
   db.add(user)
   db.commit()
   
   # –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å
   record = UserRecord(
       telegram_id=message.from_user.id,
       date=date.today(),
       weight=weight,
       waist=waist,
       neck=neck,
       hip=hip,
       height=height,
       goal=goal,
       steps=steps,
       sport_type=sport_type,
       sport_freq=sport_freq
   )
   db.add(record)
   db.commit()
   ```

## üìù **–°—Ü–µ–Ω–∞—Ä–∏–π "–ù–æ–≤—ã–µ –∑–∞–º–µ—Ä—ã"**

**–§–∞–π–ª:** `handlers/measurements_handlers.py`

### –ü—Ä–æ—Ü–µ—Å—Å:
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å ‚Üí –Ω–∞—á–∏–Ω–∞–µ–º –∏–∑–º–µ—Ä–µ–Ω–∏—è

2. **–°–±–æ—Ä –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
   - –û–±—Ö–≤–∞—Ç —Ç–∞–ª–∏–∏
   - –û–±—Ö–≤–∞—Ç —à–µ–∏
   - –û–±—Ö–≤–∞—Ç –±–µ–¥–µ—Ä (—Ç–æ–ª—å–∫–æ –¥–ª—è –∂–µ–Ω—â–∏–Ω)
   - –í–µ—Å
   - –£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—à–∞–≥–∏)
   - –¢–∏–ø —Å–ø–æ—Ä—Ç–∞
   - –ß–∞—Å—Ç–æ—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫

3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î:**
   ```python
   # –ò—Å–ø–æ–ª—å–∑—É–µ–º create_or_update_record –¥–ª—è —É–º–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
   create_or_update_record(
       db,
       message.from_user.id,
       date.today(),
       weight=weight,
       waist=waist,
       neck=neck,
       hip=hip,
       steps=steps,
       sport_type=sport_type,
       sport_freq=sport_freq,
       step_multiplier=step_multiplier,
       height=latest_record.height,  # –ë–µ—Ä–µ–º –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏
       goal=latest_record.goal       # –ë–µ—Ä–µ–º –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏
   )
   ```

## üîÑ **–õ–æ–≥–∏–∫–∞ create_or_update_record**

```python
def create_or_update_record(db: Session, telegram_id: int, record_date: date, **kwargs):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å—å –Ω–∞ —ç—Ç—É –¥–∞—Ç—É
    existing_record = db.query(UserRecord).filter(
        and_(UserRecord.telegram_id == telegram_id, UserRecord.date == record_date)
    ).first()
    
    if existing_record:
        # UPDATE –µ—Å–ª–∏ –≤–≤–æ–¥ –≤ —Ç–æ—Ç –∂–µ –¥–µ–Ω—å
        for key, value in kwargs.items():
            if hasattr(existing_record, key) and value is not None:
                setattr(existing_record, key, value)
        db.commit()
        return existing_record
    else:
        # INSERT –µ—Å–ª–∏ –≤–≤–æ–¥ –≤ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å
        new_record = UserRecord(
            telegram_id=telegram_id,
            date=record_date,
            **filtered_kwargs
        )
        db.add(new_record)
        db.commit()
        return new_record
```

## ‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤**

### **–ß—Ç–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ:**
- ‚úÖ –û–±–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–æ–¥–Ω—É –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö**
- ‚úÖ –û–±–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–æ–¥–Ω–∏ –º–æ–¥–µ–ª–∏** (`models/tables.py`)
- ‚úÖ –û–±–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–æ–¥–Ω—É –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** (aiogram 2.x)
- ‚úÖ –û–±–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É `user_records`
- ‚úÖ –û–±–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–æ–ª–µ `telegram_id` –¥–ª—è —Å–≤—è–∑–∏

### **–ß—Ç–æ —Ä–∞–∑–ª–∏—á–∞–µ—Ç—Å—è:**
- üîÑ **–ü–µ—Ä–≤–æ–µ –∫–∞—Å–∞–Ω–∏–µ** —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å
- üîÑ **–ù–æ–≤—ã–µ –∑–∞–º–µ—Ä—ã** —Å–æ–∑–¥–∞—é—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- üîÑ **–ü–µ—Ä–≤–æ–µ –∫–∞—Å–∞–Ω–∏–µ** —Å–æ–±–∏—Ä–∞–µ—Ç –ø–æ–ª–Ω—É—é –∞–Ω–∫–µ—Ç—É
- üîÑ **–ù–æ–≤—ã–µ –∑–∞–º–µ—Ä—ã** —Å–æ–±–∏—Ä–∞—é—Ç —Ç–æ–ª—å–∫–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è

## üõ°Ô∏è **–ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∏–∑–º–µ—Ä–µ–Ω–∏–π
2. **–£–º–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∑–∞ —Ç–æ—Ç –∂–µ –¥–µ–Ω—å –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

## üìà **–†–µ–∑—É–ª—å—Ç–∞—Ç**

–û–±–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç **—Å–æ–≤–º–µ—Å—Ç–∏–º–æ** –∏ **–Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:
- –ü–µ—Ä–≤–æ–µ –∫–∞—Å–∞–Ω–∏–µ —Å–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å
- –ù–æ–≤—ã–µ –∑–∞–º–µ—Ä—ã –¥–æ–±–∞–≤–ª—è—é—Ç –∑–∞–ø–∏—Å–∏ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
- –ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 